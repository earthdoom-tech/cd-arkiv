<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Min CD-samling</title>
  <style>
    :root { --max: 980px; --b:#e8e8e8; --t:#111; --m:#666; --bg:#fff; --chip:#f4f4f4; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:var(--t);background:var(--bg);}
    header{border-bottom:1px solid var(--b);padding:22px 16px;}
    main{padding:18px 16px 60px;}
    .wrap{max-width:var(--max);margin:0 auto;}
    h1{margin:0 0 8px;font-size:28px;}
    .lead{margin:0;color:var(--m);line-height:1.45}
    .bar{display:grid;grid-template-columns:1fr;gap:10px;margin-top:14px}
    .row{display:grid;grid-template-columns:1fr 160px 220px;gap:10px}
    input,select,button{font:inherit;padding:11px 12px;border:1px solid var(--b);border-radius:12px;background:#fff}
    button{cursor:pointer;background:var(--chip)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{border:1px solid var(--b);background:var(--chip);border-radius:999px;padding:7px 10px;font-size:13px;cursor:pointer}
    .chip[data-active="true"]{background:#fff}
    .grid{display:grid;gap:12px;margin-top:14px}
    .card{border:1px solid var(--b);border-radius:16px;padding:14px 14px 12px}
    .name{font-weight:800}
    .meta{color:var(--m);font-size:14px}
    .stars{letter-spacing:1px}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .tag{font-size:12px;padding:4px 8px;border:1px solid var(--b);border-radius:999px;background:#fff;color:var(--m)}
    .notes{margin:10px 0 0;line-height:1.45}
    .when{margin:8px 0 0;color:var(--m);font-size:14px}
    .link{display:inline-block;margin-top:10px;text-decoration:none}
    .muted{color:var(--m)}
    @media (max-width: 820px){
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Min CD-samling</h1>
      <p class="lead">
        Ett personligt lyssningsarkiv. SÃ¶k, filtrera eller slumpa fram en skiva
        att lyssna pÃ¥.
      </p>

      <div class="bar">
        <div class="row">
          <input id="q" type="search" placeholder="SÃ¶k: artist, album, taggar, noterâ€¦" />
          <select id="minRating">
            <option value="0">Betyg: alla</option>
            <option value="3">Minst 3â˜…</option>
            <option value="4">Minst 4â˜…</option>
            <option value="5">Endast 5â˜…</option>
          </select>
          <button id="randomBtn">ðŸŽ² Slumpa en skiva</button>
        </div>

        <div class="chips" id="tagChips"></div>
        <div class="muted" id="status"></div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid" id="list"></div>
    </div>
  </main>

  <script>
    const els = {
      q: document.getElementById("q"),
      minRating: document.getElementById("minRating"),
      list: document.getElementById("list"),
      status: document.getElementById("status"),
      tagChips: document.getElementById("tagChips"),
      randomBtn: document.getElementById("randomBtn"),
    };

    let data = [];
    let activeTag = "";

    const norm = (s) => (s || "").toString().toLowerCase().trim();

    function stars(n){
      return "â˜…".repeat(n) + "â˜†".repeat(5 - n);
    }

    function render(){
      const q = norm(els.q.value);
      const min = parseInt(els.minRating.value, 10);
      const items = data.filter(i => {
        if ((i.rating || 0) < min) return false;
        if (activeTag && !(i.tags || []).includes(activeTag)) return false;
        if (!q) return true;
        const hay = norm([i.artist,i.album,i.notes,(i.tags||[]).join(" ")].join(" "));
        return hay.includes(q);
      });

      els.list.innerHTML = items.map(i => `
        <div class="card">
          <div class="name">${i.artist} â€“ ${i.album}</div>
          <div class="meta">${stars(i.rating || 0)} ${i.year || ""}</div>
          ${i.notes ? `<div class="notes">${i.notes}</div>` : ""}
          ${i.listenWhen ? `<div class="when"><strong>Lyssna nÃ¤r:</strong> ${i.listenWhen}</div>` : ""}
          <div class="tags">${(i.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>
          ${i.discogs ? `<a class="link" href="${i.discogs}" target="_blank">Discogs</a>` : ""}
        </div>
      `).join("");

      els.status.textContent = `${items.length} trÃ¤ffar`;
    }

    function buildTags(){
      const tags = [...new Set(data.flatMap(i => i.tags || []))].sort();
      els.tagChips.innerHTML =
        `<span class="chip" data-tag="">Alla</span>` +
        tags.map(t => `<span class="chip" data-tag="${t}">${t}</span>`).join("");

      els.tagChips.querySelectorAll(".chip").forEach(c => {
        c.onclick = () => {
          activeTag = c.dataset.tag || "";
          render();
        };
      });
    }

    async function init(){
      const res = await fetch("data.json", { cache: "no-store" });
      data = await res.json();
      buildTags();
      render();

      els.q.oninput = render;
      els.minRating.onchange = render;
      els.randomBtn.onclick = () => {
        const i = data[Math.floor(Math.random() * data.length)];
        els.q.value = "";
        els.minRating.value = 0;
        activeTag = "";
        els.list.innerHTML = "";
        els.list.innerHTML = `
          <div class="card">
            <div class="name">${i.artist} â€“ ${i.album}</div>
            <div class="meta">${stars(i.rating || 0)} ${i.year || ""}</div>
            ${i.notes ? `<div class="notes">${i.notes}</div>` : ""}
            ${i.listenWhen ? `<div class="when"><strong>Lyssna nÃ¤r:</strong> ${i.listenWhen}</div>` : ""}
            <div class="tags">${(i.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>
            ${i.d
